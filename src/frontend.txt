"use client";

import * as React from "react";
import { motion, AnimatePresence } from "motion/react";
import { Button } from "@/components/ui/button";
import { cn } from "@/lib/utils";
import { ChevronDown } from "lucide-react";
import { StageId } from "@/types/lead-stage-types";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "../ui/tooltip";
import {
  canViewToOrderLoginDetails,
  canViewToProductionDetails,
} from "./privileges";
import { useAppSelector } from "@/redux/store";
import CustomeTooltip from "../cutome-tooltip";

type GroupKey = "leads" | "project" | "production" | "installation";

interface GroupedSmoothTabProps {
  groups: Record<
    GroupKey,
    ReadonlyArray<{ id: StageId; title: string; component: React.ReactNode }>
  >;
  defaultTabId: StageId;
  onChange?: (tabId: StageId) => void;
  maxVisibleStage?: StageId;
}

const groupLabels: Record<GroupKey, string> = {
  leads: "Leads",
  project: "Project",
  production: "Production",
  installation: "Installation",
};

export default function GroupedSmoothTab({
  groups,
  defaultTabId,
  onChange,
  maxVisibleStage,
}: GroupedSmoothTabProps) {
  const [activeTab, setActiveTab] = React.useState<StageId>(defaultTabId);

  const [hoveredGroup, setHoveredGroup] = React.useState<GroupKey | null>(null);

  const userType = useAppSelector(
    (state) => state.auth?.user?.user_type.user_type as string | undefined
  );

  // ‚úÖ Limit visible items by maxVisibleStage
  const visibleGroups = React.useMemo(() => {
    if (!maxVisibleStage) return groups;

    const allStageOrder: StageId[] = [
      "details",
      "measurement",
      "designing",
      "booking",
      "finalMeasurement",
      "clientdocumentation",
      "clientApproval",
      "techcheck",
      "orderLogin",
      "production",
      "readyToDispatch",
      "siteReadiness",
      "dispatchPlanning", 
      "dispatch",
      "underInstallation",
    ];

    const maxIndex = allStageOrder.indexOf(maxVisibleStage);
    const visibleSet = new Set(allStageOrder.slice(0, maxIndex + 1));

    const filteredGroups = {} as typeof groups;
    (Object.keys(groups) as GroupKey[]).forEach((key) => {
      filteredGroups[key] = groups[key].filter((i) => visibleSet.has(i.id));
    });

    return filteredGroups;
  }, [groups, maxVisibleStage]);

  const [activeGroup, setActiveGroup] = React.useState<GroupKey>(() => {
    const foundGroup = (Object.keys(groups) as GroupKey[]).find((g) =>
      groups[g].some((i) => i.id === defaultTabId)
    );
    return foundGroup && visibleGroups[foundGroup].length > 0
      ? (foundGroup as GroupKey)
      : "leads";
  });

  const allItems = React.useMemo(
  () => [
    ...(visibleGroups.leads || []),
    ...(visibleGroups.project || []),
    ...(visibleGroups.production || []),
    ...(visibleGroups.installation || []),
  ],
  [visibleGroups]
);

  const activeComponent = React.useMemo(
    () => allItems.find((i) => i.id === activeTab)?.component,
    [allItems, activeTab]
  );

  const handleSelect = (g: GroupKey, id: StageId) => {
    setActiveGroup(g);
    setActiveTab(id);
    setHoveredGroup(null);
    onChange?.(id);
  };

  const getActiveTabTitle = () => {
    return allItems.find((i) => i.id === activeTab)?.title || "";
  };

  return (
    <div className="flex flex-col h-full">
      {/* ShadCN-style tabs with hover dropdowns */}
      <div className="flex items-center gap-2 border-b px-1">
        {(Object.keys(visibleGroups) as GroupKey[]).map((g) => {
          const isActive = activeGroup === g;
          const isHovered = hoveredGroup === g;
          const items = visibleGroups[g];

          return (
            <div
              key={g}
              className="relative"
              onMouseEnter={() => setHoveredGroup(g)}
              onMouseLeave={() => setHoveredGroup(null)}
            >
              <Button
                variant="ghost"
                className={cn(
                  "relative px-4 h-10 rounded-none border-b-0.5 transition-all duration-200",
                  isActive
                    ? "border-primary text-foreground font-semibold after:absolute after:bottom-0 after:left-0 after:w-full after:h-[2px] after:bg-primary after:rounded-full after:transition-all after:duration-300"
                    : "border-transparent text-muted-foreground hover:text-foreground hover:border-muted"
                )}
              >
                <span className="flex items-center gap-1.5">
                  {groupLabels[g]}
                  <ChevronDown
                    className={cn(
                      "w-3.5 h-3.5 transition-transform duration-200",
                      isHovered && "rotate-180"
                    )}
                  />
                </span>
              </Button>

              {/* Dropdown menu on hover */}
              <AnimatePresence>
                {isHovered && (
                  <motion.div
                    initial={{ opacity: 0, y: -8 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: -8 }}
                    transition={{ duration: 0.15 }}
                    className="absolute top-full left-0 mt-1 w-56 bg-popover rounded-md border shadow-md z-50"
                  >
                    <div className="p-1">
                      <TooltipProvider>
                        {items.map((item) => {
                          // üîç Role-based permission checks
                          const canViewOrderLogin =
                            canViewToOrderLoginDetails(userType);
                          const canViewProduction =
                            canViewToProductionDetails(userType);

                          // üëá Compute disabled state and tooltip dynamically
                          const isDisabled =
                            (item.id === "orderLogin" && !canViewOrderLogin) ||
                            (item.id === "production" && !canViewProduction);

                          const tooltipText = isDisabled
                            ? item.id === "orderLogin"
                              ? "You don‚Äôt have permission to access Order Login"
                              : "You don‚Äôt have permission to access Production Stage"
                            : null;

                          return (
                            <div key={item.id}>
                              {tooltipText ? (
                                <CustomeTooltip
                                  truncateValue={
                                    <button
                                      onClick={() =>
                                        !isDisabled && handleSelect(g, item.id)
                                      }
                                      disabled={isDisabled}
                                      className={cn(
                                        "relative w-full px-2 py-1.5 text-sm rounded-sm text-left transition-colors",
                                        isDisabled
                                          ? "opacity-50 cursor-not-allowed"
                                          : "hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground outline-none",
                                        activeTab === item.id &&
                                          "bg-primary/10 text-primary font-medium rounded-sm"
                                      )}
                                    >
                                      {item.title}
                                      {activeTab === item.id && !isDisabled && (
                                        <motion.div
                                          layoutId="active-indicator"
                                          className="absolute inset-0 bg-accent rounded-sm -z-10"
                                          transition={{
                                            type: "spring",
                                            stiffness: 380,
                                            damping: 30,
                                          }}
                                        />
                                      )}
                                    </button>
                                  }
                                  value={tooltipText}
                                />
                              ) : (
                                <button
                                  onClick={() =>
                                    !isDisabled && handleSelect(g, item.id)
                                  }
                                  disabled={isDisabled}
                                  className={cn(
                                    "relative w-full px-2 py-1.5 text-sm rounded-sm text-left transition-colors",
                                    isDisabled
                                      ? "opacity-50 cursor-not-allowed"
                                      : "hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground outline-none",
                                    activeTab === item.id &&
                                      "bg-primary/10 text-primary font-medium rounded-sm"
                                  )}
                                >
                                  {item.title}
                                  {activeTab === item.id && !isDisabled && (
                                    <motion.div
                                      layoutId="active-indicator"
                                      className="absolute inset-0 bg-accent rounded-sm -z-10"
                                      transition={{
                                        type: "spring",
                                        stiffness: 380,
                                        damping: 30,
                                      }}
                                    />
                                  )}
                                </button>
                              )}
                            </div>
                          );
                        })}
                      </TooltipProvider>
                    </div>
                  </motion.div>
                )}
              </AnimatePresence>
            </div>
          );
        })}

        {/* Active tab indicator badge */}
        <div className="ml-auto py-1 px-3 rounded-2xl flex items-center justify-center gap-2 bg-muted text-xs text-muted-foreground">
          <span className="w-2 h-2 bg-green-500 rounded-full"></span>
          <p className="rounded-md text-foreground font-medium">
            {getActiveTabTitle()}
          </p>
        </div>
      </div>

      {/* Active content with smooth transitions */}
      <div className="relative flex-1 mt-4">
        <AnimatePresence mode="wait">
          <motion.div
            key={activeTab}
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -10 }}
            transition={{ duration: 0.2 }}
            className="h-full"
          >
            {activeComponent}
          </motion.div>
        </AnimatePresence>
      </div>
    </div>
  );
}

"use client";
import React from "react";
import OpenLeadDetails from "@/components/tabScreens/OpenLeadDetails";
import BookingLeadsDetails from "@/components/sales-executive/booking-stage/view-booking-modal";
import SiteMeasurementLeadDetails from "@/components/tabScreens/SiteMeasurementLeadDetails";
import DesigningLeadsDetails from "@/components/tabScreens/DesigningLeadDetails";
import FinalMeasurementLeadDetails from "@/components/tabScreens/FinalMeasurementDetails";
import ClientDocumentationDetails from "@/components/site-supervisor/client-documentation/view-client-documentation";
import ClientApprovalDetails from "@/components/site-supervisor/client-approval/client-approval-details";
import TechCheckDetails from "@/components/production/tech-check-stage/TechCheckDetails";
import OrderLoginDetails from "@/components/production/order-login-stage/OrderLoginDetails";
import LeadDetailsProductionUtil from "@/components/production/pre-production-stage/lead-details-production-tabs";

import ReadyToDispatchDetails from "../production/ready-to-dispatch/ReadyToDispatchDetails";
import SiteReadinessTabs from "../installation/site-readiness/SiteReadinessTabs";
import DispatchPlanningDetails from "../installation/dispatch-planning/DispatchPlanningDetails";
import DispatchTabsWrapper from "../installation/dispatch/DispatchTabsWrapper";

type StatusKey = StageId;
import GroupedSmoothTab from "./grouped-smooth-tab";
import { StageId } from "@/types/lead-stage-types";
import UnderInstallationTabsWrapper from "../installation/under-installation/UnderInstallationTabsWrapper";

type GroupKey = "leads" | "project" | "production" | "installation";

export interface LeadDetailsGroupedProps {
  defaultTab?: StageId;
  status?: StageId;
  leadId: number;
  accountId: number;
  onChangeTab?: (tabId: StageId) => void;
  leadName?: string;
  maxVisibleStage?: StageId;
  /** üëá NEW PROP to control visible group range */
  defaultParentTab?: GroupKey;
}

const GROUP_ORDER: GroupKey[] = [
  "leads",
  "project",
  "production",
  "installation",
];

export default function LeadDetailsGrouped({
  defaultTab,
  status,
  leadId,
  accountId,
  onChangeTab,
  leadName,
  maxVisibleStage,
  defaultParentTab = "installation", // default: show all
}: LeadDetailsGroupedProps) {
  const groups = {
    leads: [
      {
        id: "details",
        title: "Lead Details",
        component: <OpenLeadDetails leadId={leadId} />,
      },
      {
        id: "measurement",
        title: "Site Measurement",
        component: <SiteMeasurementLeadDetails leadId={leadId} />,
      },
      {
        id: "designing",
        title: "Designing",
        component: <DesigningLeadsDetails leadId={leadId} />,
      },
      {
        id: "booking",
        title: "Booking",
        component: <BookingLeadsDetails leadId={leadId} />,
      },
    ],
    project: [
      {
        id: "finalMeasurement",
        title: "Final Measurement",
        component: <FinalMeasurementLeadDetails leadId={leadId} />,
      },
      {
        id: "clientdocumentation",
        title: "Client Documentation",
        component: (
          <ClientDocumentationDetails
            leadId={leadId}
            accountId={accountId}
            name={leadName}
          />
        ),
      },
      {
        id: "clientApproval",
        title: "Client Approval",
        component: <ClientApprovalDetails leadId={leadId} />,
      },
    ],
    production: [
      {
        id: "techcheck",
        title: "Tech Check",
        component: (
          <TechCheckDetails
            leadId={leadId}
            accountId={accountId}
            name={leadName}
          />
        ),
      },
      {
        id: "orderLogin",
        title: "Order Login",
        component: (
          <OrderLoginDetails
            leadId={leadId}
            accountId={accountId}
            name={leadName}
          />
        ),
      },
      {
        id: "production",
        title: "Production Stage",
        component: (
          <LeadDetailsProductionUtil leadId={leadId} accountId={accountId} />
        ),
      },
      {
        id: "readyToDispatch",
        title: "Ready To Dispatch",
        component: (
          <ReadyToDispatchDetails
            leadId={leadId}
            accountId={accountId}
            name={leadName}
          />
        ),
      },
    ],
    installation: [
      {
        id: "siteReadiness",
        title: "Site Readiness",
        component: (
          <SiteReadinessTabs
            leadId={leadId}
            accountId={accountId}
            name={leadName}
          />
        ),
      },
      {
        id: "dispatchPlanning",
        title: "Dispatch Planning",
        component: (
          <DispatchPlanningDetails leadId={leadId} accountId={accountId} />
        ), // ‚úÖ new component
      },
      {
        id: "dispatch",
        title: "Dispatch",
        component: (
          <DispatchTabsWrapper
            leadId={leadId}
            accountId={accountId}
            name={leadName}
          />
        ),
      },
      {
        id: "underInstallation",
        title: "Under Installation",
        component: (
          <UnderInstallationTabsWrapper
            leadId={leadId}
            accountId={accountId}
            name={leadName}
          />
        ),
      },
    ],
  } as const;

  // ‚úÖ Filter based on defaultParentTab
  const visibleGroups = React.useMemo(() => {
    const allowedKeys = GROUP_ORDER.slice(
      0,
      GROUP_ORDER.indexOf(defaultParentTab) + 1
    );

    const filtered = {} as Record<
      GroupKey,
      { id: StageId; title: string; component: React.ReactNode }[]
    >;

    for (const key of allowedKeys) {
      const stages = groups[key];

      // agar ye last allowed group hai to andar se cutoff lagao
      if (key === defaultParentTab && status) {
        const stageOrder: StageId[] = [
          "details",
          "measurement",
          "designing",
          "booking",
          "finalMeasurement",
          "clientdocumentation",
          "clientApproval",
          "techcheck",
          "orderLogin",
          "production",
          "readyToDispatch",
          "siteReadiness",
          "dispatchPlanning",
          "dispatch",
          "underInstallation",
        ];

        const maxIndex = stageOrder.indexOf(status);
        filtered[key] = stages.filter(
          (s) => stageOrder.indexOf(s.id) <= maxIndex
        );
      } else {
        filtered[key] = [...stages];
      }
    }

    return filtered;
  }, [defaultParentTab, status]);

  const initialTab: StageId = defaultTab ?? (status ? status : "details");

  return (
    <GroupedSmoothTab
      groups={visibleGroups}
      defaultTabId={initialTab}
      onChange={onChangeTab}
      maxVisibleStage={maxVisibleStage}
    />
  );
}

similar ui i want 

"use client";

import React, { useState } from "react";
import { ScrollArea } from "@/components/ui/scroll-area";
import { useAppSelector } from "@/redux/store";
import { useQueryClient } from "@tanstack/react-query";
import { format } from "date-fns";
import { FolderOpen, Upload, ExternalLink, Loader2 } from "lucide-react";
import { Button } from "@/components/ui/button";
import { FileUploadField } from "@/components/custom/file-upload";
import { toast } from "react-toastify";
import {
  usePostProductionCompleteness,
  useQcPhotos,
  useUploadQcPhotos,
} from "@/api/production/production-api";
import { useDeleteDocument } from "@/api/leads";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import ImageCarouselModal from "@/components/utils/image-carousel-modal";
import { ImageComponent } from "@/components/utils/ImageCard";
import DocumentCard from "@/components/utils/documentCard";
import { useLeadStatus } from "@/hooks/designing-stage/designing-leads-hooks";
import { canViewAndWorkProductionStage } from "@/components/utils/privileges";

interface PostProductionQcPhotosSectionProps {
  leadId: number;
  accountId: number | null;
}

export default function PostProductionQcPhotosSection({
  leadId,
  accountId,
}: PostProductionQcPhotosSectionProps) {
  const vendorId = useAppSelector((s) => s.auth.user?.vendor_id);
  const userId = useAppSelector((s) => s.auth.user?.id);
  const userType = useAppSelector((s) => s.auth.user?.user_type?.user_type);

  const queryClient = useQueryClient();

  const { data: qcPhotos, isLoading } = useQcPhotos(vendorId, leadId);
  const { mutateAsync: uploadQcFiles, isPending } = useUploadQcPhotos(
    vendorId,
    leadId
  );

  const { data: leadData, error } = useLeadStatus(leadId, vendorId);
  const leadStatus = leadData?.status;

  const { mutate: deleteDocument, isPending: deleting } =
    useDeleteDocument(leadId);
  const { data: completeness, refetch: refetchCompleteness } =
    usePostProductionCompleteness(vendorId, leadId);

  const [openCarousel, setOpenCarousel] = useState(false);
  const [startIndex, setStartIndex] = useState(0);
  const [confirmDelete, setConfirmDelete] = useState<null | number>(null);

  const [selectedFiles, setSelectedFiles] = useState<File[]>([]);
  const hasFiles = Array.isArray(qcPhotos) && qcPhotos.length > 0;

  const imageExtensions = ["jpg", "jpeg", "png"];
  const documentExtensions = ["pdf", "zip"];

  const images =
    qcPhotos?.filter((file: any) => {
      const ext = file.doc_og_name?.split(".").pop()?.toLowerCase();
      return imageExtensions.includes(ext || "");
    }) || [];

  const Documents =
    qcPhotos?.filter((file: any) => {
      const ext = file.doc_og_name?.split(".").pop()?.toLowerCase();
      return documentExtensions.includes(ext || "");
    }) || [];

  const handleUpload = async () => {
    if (selectedFiles.length === 0) {
      toast.error("Please select at least one photo to upload.");
      return;
    }

    try {
      const formData = new FormData();
      selectedFiles.forEach((file) => formData.append("files", file));
      formData.append("created_by", String(userId || 0));
      if (accountId) formData.append("account_id", String(accountId));

      await uploadQcFiles(formData);
      toast.success("QC photos uploaded successfully!");
      setSelectedFiles([]);

      queryClient.invalidateQueries({
        queryKey: ["qcPhotos", vendorId, leadId],
      });
      queryClient.invalidateQueries({
        queryKey: ["postProductionCompleteness", vendorId, leadId],
      });
      await refetchCompleteness();
    } catch (error: any) {
      toast.error(
        error?.response?.data?.message || "Failed to upload QC photos."
      );
    }
  };

  const canDelete = userType === "admin" || userType === "super-admin";
  const canViewAndWork = canViewAndWorkProductionStage(userType, leadStatus);

  // üß© --- Handlers ---
  const handleConfirmDelete = () => {
    if (confirmDelete) {
      deleteDocument({
        vendorId: vendorId!,
        documentId: confirmDelete,
        deleted_by: userId!,
      });
      setConfirmDelete(null);
    }
  };
  return (
    <div className="border rounded-lg overflow-hidden bg-background">
      {/* Header */}
      <div className="px-6 py-4 border-b bg-muted/20 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <FolderOpen className="w-5 h-5" />
          <h2 className="text-lg font-semibold">QC Photos</h2>
        </div>
        <p className="text-xs text-muted-foreground">
          Upload and manage Quality Check photos.
        </p>
      </div>

      {/* Upload Section */}
      {canViewAndWork && (
        <div className="p-6 border-b space-y-4">
          <FileUploadField
            value={selectedFiles}
            onChange={setSelectedFiles}
            accept=".jpg,.jpeg,.png,.pdf,.zip"
            multiple
          />

          <div className="flex justify-end">
            <Button
              size="sm"
              onClick={handleUpload}
              disabled={isPending || selectedFiles.length === 0}
              className="flex items-center gap-2"
            >
              {isPending ? (
                <>
                  <Loader2 className="animate-spin size-4" />
                  Uploading...
                </>
              ) : (
                <>
                  <Upload size={16} />
                  Upload Photos
                </>
              )}
            </Button>
          </div>
        </div>
      )}

      {/* Files List */}
      <div className="p-6">
        <div className="flex justify-between items-center mb-3">
          <h4 className="text-sm font-semibold text-foreground">
            Uploaded Photos
          </h4>
          {hasFiles && (
            <span className="text-xs text-muted-foreground">
              {qcPhotos.length} photo{qcPhotos.length > 1 ? "s" : ""}
            </span>
          )}
        </div>

        {isLoading ? (
          <div className="flex justify-center py-10 text-sm text-muted-foreground">
            <Loader2 className="animate-spin mr-2 size-4" />
            Loading QC photos...
          </div>
        ) : !hasFiles ? (
          <div className="p-8 border border-dashed rounded-lg flex flex-col items-center justify-center text-center bg-muted/30">
            <FolderOpen className="w-10 h-10 text-muted-foreground mb-2" />
            <p className="text-sm font-medium text-muted-foreground">
              No QC photos uploaded yet.
            </p>
          </div>
        ) : (
          <ScrollArea className="max-h-[400px] mt-2 pr-2">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
              {images.map((doc: any, index: number) => (
                <ImageComponent
                  doc={{
                    id: doc?.id,
                    doc_og_name: doc.doc_og_name,
                    signedUrl: doc.signed_url,
                    created_at: doc.created_at,
                  }}
                  index={index}
                  canDelete={canDelete}
                  onView={(i) => {
                    setStartIndex(i);
                    setOpenCarousel(true);
                  }}
                  onDelete={(id) => setConfirmDelete(Number(id))}
                />
              ))}

              {Documents.map((doc: any) => (
                <DocumentCard
                  key={doc.id}
                  doc={{
                    id: doc.id,
                    originalName: doc.doc_og_name,
                    signedUrl: doc.signed_url,
                    created_at: doc.created_at,
                  }}
                  canDelete={canDelete}
                  onDelete={(id) => setConfirmDelete(id)}
                />
              ))}
            </div>
          </ScrollArea>
        )}
      </div>

      <AlertDialog
        open={!!confirmDelete}
        onOpenChange={() => setConfirmDelete(null)}
      >
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Delete Document?</AlertDialogTitle>
            <AlertDialogDescription>
              This action cannot be undone. The selected document will be
              permanently removed from the system.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={deleting}>Cancel</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleConfirmDelete}
              disabled={deleting}
            >
              {deleting ? "Deleting..." : "Delete"}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
      <ImageCarouselModal
        images={images}
        open={openCarousel}
        initialIndex={startIndex}
        onClose={() => setOpenCarousel(false)}
      />
    </div>
  );
}
